/**
 * AJAX Upload ( http://valums.com/ajax-upload/ ) 
 * Copyright (c) Andris Valums
 * Licensed under the MIT license ( http://valums.com/mit-license/ )
 * Thanks to Gary Haran, David Mark, Corey Burns and others for contributions 
 */
!function($){function log(){"undefined"!=typeof console&&"function"==typeof console.log&&(Array.prototype.unshift.call(arguments,"[Ajax Upload]"),console.log(Array.prototype.join.call(arguments," ")))}function addEvent(a,b,c){if(a.addEventListener)a.addEventListener(b,c,!1);else{if(!a.attachEvent)throw new Error("not supported or DOM not loaded");a.attachEvent("on"+b,function(){c.call(a)})}}function addResizeEvent(a){var b;addEvent(window,"resize",function(){b&&clearTimeout(b),b=setTimeout(a,100)})}function getBox(a){var f=getOffset(a),b=f.left,d=f.top,c=b+a.offsetWidth,e=d+a.offsetHeight;return{left:b,right:c,top:d,bottom:e}}function addStyles(a,b){for(var c in b)b.hasOwnProperty(c)&&(a.style[c]=b[c])}function copyLayout(a,b){var c=getBox(a);addStyles(b,{position:"absolute",left:c.left+"px",top:c.top+"px",width:a.offsetWidth+"px",height:a.offsetHeight+"px"})}function fileFromPath(a){return a.replace(/.*(\/|\\)/,"")}function getExt(a){return-1!==a.indexOf(".")?a.replace(/.*[.]/,""):""}function hasClass(a,b){var c=new RegExp("\\b"+b+"\\b");return c.test(a.className)}function addClass(a,b){hasClass(a,b)||(a.className+=" "+b)}function removeClass(a,b){var c=new RegExp("\\b"+b+"\\b");a.className=a.className.replace(c,"")}function removeNode(a){a.parentNode.removeChild(a)}var getOffset,toElement,getUID;getOffset=document.documentElement.getBoundingClientRect?function(a){var i,j,k,b=a.getBoundingClientRect(),c=a.ownerDocument,d=c.body,e=c.documentElement,f=e.clientTop||d.clientTop||0,g=e.clientLeft||d.clientLeft||0,h=1;return d.getBoundingClientRect&&(i=d.getBoundingClientRect(),h=(i.right-i.left)/d.clientWidth),h>1&&(f=0,g=0),j=b.top/h+(window.pageYOffset||e&&e.scrollTop/h||d.scrollTop/h)-f,k=b.left/h+(window.pageXOffset||e&&e.scrollLeft/h||d.scrollLeft/h)-g,{top:j,left:k}}:function(a){var b=0,c=0;do b+=a.offsetTop||0,c+=a.offsetLeft||0,a=a.offsetParent;while(a);return{left:c,top:b}},toElement=function(){var a=document.createElement("div");return function(b){a.innerHTML=b;var c=a.firstChild;return a.removeChild(c)}}(),getUID=function(){var a=0;return function(){return"ValumsAjaxUpload"+a++}}(),window.AjaxUpload=function(a,b){this._settings={action:"upload.php",name:"userfile",accept:"*",data:{},autoSubmit:!0,responseType:!1,hoverClass:"hover",disabledClass:"disabled",onChange:function(){},onSubmit:function(){},onComplete:function(){}};for(var c in b)b.hasOwnProperty(c)&&(this._settings[c]=b[c]);if(a.jquery?a=a[0]:"string"==typeof a&&(/^#.*/.test(a)&&(a=a.slice(1)),a=document.getElementById(a)),!a||1!==a.nodeType)throw new Error("Please make sure that you're passing a valid element");"A"==a.nodeName.toUpperCase()&&addEvent(a,"click",function(a){a&&a.preventDefault?a.preventDefault():window.event&&(window.event.returnValue=!1)}),this._button=a,this._input=null,this._disabled=!1,this.enable(),this._rerouteClicks()},AjaxUpload.prototype={setData:function(a){this._settings.data=a},disable:function(){addClass(this._button,this._settings.disabledClass),this._disabled=!0;var a=this._button.nodeName.toUpperCase();("INPUT"==a||"BUTTON"==a)&&this._button.setAttribute("disabled","disabled"),this._input&&(this._input.parentNode.style.visibility="hidden")},enable:function(){removeClass(this._button,this._settings.disabledClass),this._button.removeAttribute("disabled"),this._disabled=!1},_createInput:function(){var c,a=this,b=document.createElement("input");if(b.setAttribute("type","file"),b.setAttribute("accept",this._settings.accept),b.setAttribute("name",this._settings.name),addStyles(b,{position:"absolute",right:0,margin:0,padding:0,fontSize:"480px",cursor:"pointer"}),c=document.createElement("div"),addStyles(c,{display:"block",position:"absolute",overflow:"hidden",margin:0,padding:0,opacity:0,direction:"ltr",zIndex:2147483583}),"0"!==c.style.opacity){if("undefined"==typeof c.filters)throw new Error("Opacity not supported by the browser");c.style.filter="alpha(opacity=0)"}addEvent(b,"change",function(){if(b&&""!==b.value){var c=fileFromPath(b.value);return!1===a._settings.onChange.call(a,c,getExt(c))?(a._clearInput(),void 0):(a._settings.autoSubmit&&a.submit(),void 0)}}),addEvent(b,"mouseover",function(){addClass(a._button,a._settings.hoverClass)}),addEvent(b,"mouseout",function(){removeClass(a._button,a._settings.hoverClass),$(b).parent().css("visibility","hidden")}),c.appendChild(b),document.body.appendChild(c),this._input=b},_clearInput:function(){this._input&&(removeNode(this._input.parentNode),this._input=null,this._createInput(),removeClass(this._button,this._settings.hoverClass))},_rerouteClicks:function(){var a=this;addEvent(a._button,"mouseover",function(){if(!a._disabled){a._input||a._createInput();var b=a._input.parentNode;copyLayout(a._button,b),b.style.visibility="visible"}})},_createIframe:function(){var a=getUID(),b=toElement('<iframe src="javascript:false;" name="'+a+'" />');return b.setAttribute("id",a),b.style.display="none",document.body.appendChild(b),b},_createForm:function(a){var d,e,b=this._settings,c=toElement('<form method="post" enctype="multipart/form-data"></form>');c.setAttribute("action",b.action),c.setAttribute("target",a.name),c.style.display="none",document.body.appendChild(c);for(d in b.data)b.data.hasOwnProperty(d)&&(e=document.createElement("input"),e.setAttribute("type","hidden"),e.setAttribute("name",d),e.setAttribute("value",b.data[d]),c.appendChild(e));return c},_getResponse:function(iframe,file){var toDeleteFlag=!1,self=this,settings=this._settings;addEvent(iframe,"load",function(){var doc,response;return"javascript:'%3Chtml%3E%3C/html%3E';"==iframe.src||"javascript:'<html></html>';"==iframe.src?(toDeleteFlag&&setTimeout(function(){removeNode(iframe)},0),void 0):(doc=iframe.contentDocument?iframe.contentDocument:window.frames[iframe.id].document,doc.readyState&&"complete"!=doc.readyState||doc.body&&"false"==doc.body.innerHTML||(doc.XMLDocument?response=doc.XMLDocument:doc.body?(response=doc.body.innerHTML,settings.responseType&&"json"==settings.responseType.toLowerCase()&&(doc.body.firstChild&&"PRE"==doc.body.firstChild.nodeName.toUpperCase()&&(response=doc.body.firstChild.firstChild.nodeValue),response=response?eval("("+response+")"):{})):response=doc,settings.onComplete.call(self,file,response),toDeleteFlag=!0,iframe.src="javascript:'<html></html>';"),void 0)})},submit:function(){var c,d,e,a=this,b=this._settings;if(this._input&&""!==this._input.value){if(c=fileFromPath(this._input.value),!1===b.onSubmit.call(this,c,getExt(c)))return this._clearInput(),void 0;d=this._createIframe(),e=this._createForm(d),removeNode(this._input.parentNode),removeClass(a._button,a._settings.hoverClass),e.appendChild(this._input),e.submit(),removeNode(e),e=null,removeNode(this._input),this._input=null,this._getResponse(d,c),this._createInput()}}}}(jQuery);