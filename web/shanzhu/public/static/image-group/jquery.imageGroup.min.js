!function(a){var b=function(b,c,d){var f,g,h,i,e=window.top!=window.self?window.top.document:window.self.document;a.each(["name","desc"],function(a,b){"undefined"==typeof c[b]&&(c[b]="")}),f={modal:!0,resizable:!1,dialogClass:"jquery-ui-dialog-iframe jquery-dialog-form",closeText:"",title:"图片属性",width:530,close:function(){a(this).remove()},buttons:[{text:"确定",click:function(){if(a.isFunction(d)){var c={};b.isName&&(c.name=a("#image_group_dialog_name",e).val()),b.isDesc&&(c.desc=a("#image_group_dialog_desc",e).val()),d(c)}a(this).dialog("close").remove()}},{text:"取消",click:function(){a(this).dialog("close").remove()}}]},g="",h='<td rowspan="2" style="width:100px;border-right:1px #eee solid"><center><img src="'+c.url+'" width="80" height="80" /></center></td>',b.isName&&!b.isDesc&&(f=a.extend(f,{width:430})),b.isName&&(g+='<tr>$ImageDisplay1<th style="width:50px;">图片名称</th><td><input type="text" id="image_group_dialog_name" style="width:200px" value="'+c.name+'" /></td></tr>'),b.isDesc&&(g+='<tr>$ImageDisplay2<th style="width:50px;">图片描述</th><td><textarea id="image_group_dialog_desc" style="width:300px;height:80px;">'+c.desc+"</textarea></td></tr>"),b.isDesc&&!b.isName?(g=g.replace("$ImageDisplay2",h),g=g.replace("$ImageDisplay1","")):(g=g.replace("$ImageDisplay1",h),g=g.replace("$ImageDisplay2","")),i='<div id="imageGroupDialog" style="display:none"><table>$partHtml</table></div>',i=i.replace("$partHtml",g),a("body",e).append(i),a("#imageGroupDialog",e).dialog(f)},c=function(b,c,d){d.find(".image-group-close").bind("click",function(){var h,i,j,k,f=c.find(".image-group-box"),g=f.index(d);for(h=g+1;h<f.length;h++)i=f.eq(h),j='[name="'+b.partName+"["+h+"]",k=b.partName+"["+(h-1)+"]",i.children(j+'[name]"]').attr("name",k+"[name]"),i.children(j+'[desc]"]').attr("name",k+"[desc]"),i.children(j+'[width]"]').attr("name",k+"[width]"),i.children(j+'[height]"]').attr("name",k+"[height]"),i.children(j+'[size]"]').attr("name",k+"[size]"),i.children(j+'[url]"]').attr("name",k+"[url]");d.remove(),a("#"+b.partName).val(c.find(".image-group-box").length),c.children(".image-group-add").length<=0&&e(b,c)})},d=function(d,e,f){var g,h,i,j;a.each(["name","desc","width","height","size","url"],function(a,b){"undefined"==typeof f[b]&&(f[b]="")}),g=d.partName+"["+e.find(".image-group-box").length+"]",h='<div class="image-group-box"><div class="image-group-bar"><div class="image-group-edit" style="display:none"><i class="fa fa-cog"></i></div><div class="image-group-close"><i class="fa fa-close"></i></div></div><div class="image-group-pic"><center><img src="'+f.url+'" style="display:none" /></center></div>'+'<input type="hidden" name="'+g+'[name]" class="image-group-pic-name" value="'+f.name+'" />'+'<textarea name="'+g+'[desc]" style="display:none" class="image-group-pic-desc">'+f.desc+"</textarea>"+'<input type="hidden" name="'+g+'[width]"  class="image-group-pic-width" value="'+f.width+'" />'+'<input type="hidden" name="'+g+'[height]"  class="image-group-pic-height" value="'+f.height+'" />'+'<input type="hidden" name="'+g+'[size]"  class="image-group-pic-size" value="'+f.size+'" />'+'<input type="hidden" name="'+g+'[url]"  class="image-group-pic-url" value="'+f.url+'" />',i=a(h),i.appendTo(e.children(".image-group-list")),c(d,e,i),(d.isName||d.isDesc)&&i.find(".image-group-edit").show().bind("click",function(){var a={name:i.find(".image-group-pic-name").val(),desc:i.find(".image-group-pic-desc").val(),url:i.find(".image-group-pic-url").val()};b(d,a,function(a){d.isName&&i.find(".image-group-pic-name").val(a.name),d.isDesc&&i.find(".image-group-pic-desc").val(a.desc)})}),a("#"+d.partName).val(e.find(".image-group-box").length),e.find(".image-group-box").length>=d.length&&(a("input[type=file][name="+d.uploadPart+"]").parent().remove(),e.children(".image-group-add").remove()),j=new Image,j.onload=function(){var b=j.height>j.width?{height:"80px"}:{width:"80px"};i.find(".image-group-pic img").css(b).show().bind("click",function(){var b=e.find(".image-group-box").index(i),c=[],d=[];e.find(".image-group-box img").each(function(e,f){b>e?d.push(a(f).attr("src")):c.push(a(f).attr("src"))}),c=c.concat(d),window.top!=window.self?top.$.fancybox.open(c,{padding:10,openEffect:"elastic",closeEffect:"elastic"}):a.fancybox.open(c,{padding:10,openEffect:"elastic",closeEffect:"elastic"})})},j.onerror=function(){i.find(".image-group-pic center").html('<div class="muted">无效图</div>')},j.src=f.url},e=function(c,e){e.append('<div id="'+c.partName+'_add" class="image-group-add"><i class="fa fa-picture-o fa-2x"></i><div>上传图片</div></div>');var f=e.children(".image-group-add");new AjaxUpload("#"+c.partName+"_add",{action:c.uploadUrl,name:c.uploadPart,accept:".jpg,.png,.jpeg,.gif",onSubmit:function(b,c){var d=/^(jpg|png|jpeg|gif)$/i;return d.test(c)?(f.hide(),e.children(".image-group-loading").show(),void 0):(a.sui.alert("不允许上传 *."+c+" 格式的文件。<br>格式局限于: *.jpg *.png *.jpeg *.gif"),!1)},onComplete:function(g,h){var i,j;try{f.show(),e.children(".image-group-loading").hide(),i=JSON.parse(h),0==i.code?(j=i.data,c.isName||c.isDesc?b(c,j,function(a){c.isName&&(j.name=a.name),c.isDesc&&(j.desc=a.desc),d(c,e,j)}):d(c,e,j)):a.sui.error(i.message||"网络连接超时，请检查网络")}catch(k){a.sui.error("网络连接超时，请检查网络。")}}})},f=function(b){var c=[];return b.find(".image-group-box").each(function(){var e={name:a(this).children(".image-group-pic-name").val(),desc:a(this).children(".image-group-pic-desc").val(),width:a(this).children(".image-group-pic-width").val(),height:a(this).children(".image-group-pic-height").val(),size:a(this).children(".image-group-pic-size").val(),url:a(this).children(".image-group-pic-url").val()};c.push(e)}),c},g=function(){var b="image_"+(Math.floor(99999*Math.random())+1e4);return a("input[type=file][name="+b+"]").length>0&&(b=g()),b};a.fn.imageGroup=function(b){if($this=a(this),a(this).length>1)return console.error("imagePicker只允许传入单例节点。"),void 0;if("string"!=typeof b){var c=a.extend({partName:"",length:1,isName:!0,isDesc:!0,defaults:[],uploadUrl:"upload.php",uploadPart:g()},b);$this.append('<input type="hidden" class="image-group" id="'+c.partName+'" name="'+c.partName+'" value="'+c.defaults.length+'"><div class="image-group-list"></div><div class="image-group-loading" style="display:none"><i></i><div>正在上传</div></div>'),e(c,$this),a.each(c.defaults,function(a,b){a+1>c.length||d(c,$this,b)}),$this.children(".image-group-list").sortable({stop:function(){var e,f,g,d=$this.find(".image-group-box");for(e=0;e<d.length;e++)f=d.eq(e),g=c.partName+"["+e+"]",f.children(".image-group-pic-name").attr("name",g+"[name]"),f.children(".image-group-pic-desc").attr("name",g+"[desc]"),f.children(".image-group-pic-width").attr("name",g+"[width]"),f.children(".image-group-pic-height").attr("name",g+"[height]"),f.children(".image-group-pic-size").attr("name",g+"[size]"),f.children(".image-group-pic-url").attr("name",g+"[url]")}})}else if("data"==b)return f($this)}}(jQuery);